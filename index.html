<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>FootGuard – Diabetes Foot Health Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<style>
  body{font-family:sans-serif;background:#e8f5e9;color:#333;margin:0;padding:0;}
  header{background:#43a047;color:white;padding:25px;text-align:center;}
  nav{display:flex;justify-content:center;background:#388e3c;}
  nav button{background:#388e3c;color:white;padding:10px 20px;margin:2px;border:none;cursor:pointer;}
  nav button.active, nav button:hover{background:#66bb6a;}
  section{display:none;padding:20px;max-width:900px;margin:auto;}
  section.active{display:block;}
  .chart-container{background:white;padding:20px;border-radius:10px;box-shadow:0 4px 6px rgba(0,0,0,0.1);}
  .advice{background:#c8e6c9;padding:15px;margin-top:15px;border-left:5px solid #388e3c;}
  img.responsive{max-width:100%;height:auto;border-radius:10px;}
</style>
</head>
<body>

<header>
  <h1>FootGuard – Diabetes Foot Health Dashboard</h1>
  <p>Monitoring plantar pressure for ulcer prevention</p>
</header>

<nav>
  <button class="tab-btn active" data-target="home">Home</button>
  <button class="tab-btn" data-target="pressure">Pressure Data</button>
  <button class="tab-btn" data-target="interpretation">Interpretation</button>
  <button class="tab-btn" data-target="reviews">Reviews</button>
</nav>

<section id="home" class="active">
  <h2>Welcome to FootGuard</h2>
  <p>Diabetes affects millions worldwide. High plantar pressure can cause foot ulcers, which may lead to severe complications. Early detection helps prevent serious injuries.</p>
  <img src="https://upload.wikimedia.org/wikipedia/commons/thumb/7/7c/Diabetic_foot_ulcer.png/600px-Diabetic_foot_ulcer.png" alt="Diabetic Foot" class="responsive">
  <p>FootGuard provides real-time plantar pressure monitoring using BLE sensors and ML-based risk predictions.</p>
</section>

<section id="pressure">
  <h2>Live Plantar Pressure</h2>
  <div class="chart-container">
    <canvas id="pressureChart"></canvas>
  </div>
  <button onclick="connectBLE()">Connect Arduino BLE</button>
</section>

<section id="interpretation">
  <h2>Interpretation & Advice</h2>
  <div id="adviceText" class="advice">
    <p>No data yet. Simulated readings will appear automatically.</p>
  </div>
</section>

<section id="reviews">
  <h2>User Reviews</h2>
  <p>"FootGuard helped me monitor my foot health and avoid pressure injuries." – Alex D.</p>
  <p>"The dashboard is intuitive and shows clear advice based on my readings." – Maria P.</p>
  <p>"I love that it combines sensors and AI for real-time insights." – Coach D.</p>
</section>

<script>
// --- Tabs ---
const tabs=document.querySelectorAll('.tab-btn');
tabs.forEach(tab=>tab.addEventListener('click',()=>{
  tabs.forEach(t=>t.classList.remove('active'));
  tab.classList.add('active');
  document.querySelectorAll('section').forEach(s=>s.classList.remove('active'));
  document.getElementById(tab.dataset.target).classList.add('active');
}));

// --- Chart ---
const ctx=document.getElementById('pressureChart').getContext('2d');
const pressureChart=new Chart(ctx,{
  type:'line',
  data:{labels:[],datasets:[
    {label:'Sensor 1',data:[],borderColor:'rgba(75,192,192,1)',backgroundColor:'rgba(75,192,192,0.2)',tension:0.3},
    {label:'Sensor 2',data:[],borderColor:'rgba(255,99,132,1)',backgroundColor:'rgba(255,99,132,0.2)',tension:0.3}
  ]},
  options:{responsive:true,animation:false,scales:{y:{min:0,max:100},x:{}}}
});

let pressureHistory=[];
const historyLimit=60;
let simulatedInterval;
let bleConnected=false;

// --- Simulated Data ---
function startSimulatedData(){
  simulatedInterval=setInterval(()=>{
    if(!bleConnected){
      const s1=Math.floor(Math.random()*100);
      const s2=Math.floor(Math.random()*100);
      addData(s1,s2);
    }
  },500);
}
startSimulatedData();

function addData(s1,s2){
  const time=new Date().toLocaleTimeString();
  pressureChart.data.labels.push(time);
  pressureChart.data.datasets[0].data.push(s1);
  pressureChart.data.datasets[1].data.push(s2);
  if(pressureChart.data.labels.length>50){
    pressureChart.data.labels.shift();
    pressureChart.data.datasets.forEach(d=>d.data.shift());
  }
  pressureChart.update('none');
  pressureHistory.push({mean:(s1+s2)/2,max:Math.max(s1,s2)});
  if(pressureHistory.length>historyLimit) pressureHistory.shift();
}

// --- Compute Stats ---
function computeStats(history){
  if(history.length===0) return null;
  const mean=history.reduce((a,b)=>a+b.mean,0)/history.length;
  const sorted=history.map(h=>h.mean).sort((a,b)=>a-b);
  const p90=sorted[Math.floor(0.9*sorted.length)];
  const maxVal=Math.max(...history.map(h=>h.max));
  return {mean,p90,max:maxVal};
}

// --- ML Model ---
let mlModel;
async function loadMLModel(){
  try{ mlModel=await tf.loadLayersModel('tfjs_model/model.json'); console.log('ML model loaded'); }
  catch(err){ console.warn('ML load failed, using rules',err); mlModel=null; }
}
loadMLModel();

function classifyPressureRisk(stats){
  if(!stats) return {label:"Unknown",confidence:0};
  if(!mlModel){
    // fallback: rule-based
    if(stats.mean<50 && stats.p90<60) return {label:"Low Risk",confidence:100};
    if(stats.mean>=50 && stats.mean<=70 || stats.p90>=60 && stats.p90<=75) return {label:"Moderate Risk",confidence:80};
    return {label:"High Risk",confidence:95};
  }
  // ML prediction
  let features=[stats.mean,stats.p90,stats.max].map(x=>x/100);
  const inputTensor=tf.tensor2d([features]);
  const prediction=mlModel.predict(inputTensor);
  const scores=prediction.arraySync()[0];
  const maxIndex=scores.indexOf(Math.max(...scores));
  const labels=["Low Risk","Moderate Risk","High Risk"];
  return {label:labels[maxIndex],confidence:(scores[maxIndex]*100).toFixed(1)};
}

// --- Update Advice ---
setInterval(()=>{
  const stats=computeStats(pressureHistory);
  const result=classifyPressureRisk(stats);
  const adviceText=document.getElementById("adviceText");
  if(result.label==="Low Risk") adviceText.innerHTML=`<h3>${result.label}</h3><p>Average plantar pressure is low. Continue regular foot care and monitoring. ([pubmed.ncbi.nlm.nih.gov](https://pubmed.ncbi.nlm.nih.gov/38390156))</p>`;
  else if(result.label==="Moderate Risk") adviceText.innerHTML=`<h3>${result.label}</h3><p>Moderate pressure detected. Consider adjusting footwear or consulting a clinician. ([pubmed.ncbi.nlm.nih.gov](https://pubmed.ncbi.nlm.nih.gov/38826026))</p>`;
  else adviceText.innerHTML=`<h3>${result.label}</h3><p>High pressure detected. Offloading and professional assessment recommended. ([pubmed.ncbi.nlm.nih.gov](https://pubmed.ncbi.nlm.nih.gov/40595132))</p>`;
},30000);

// --- Connect Arduino BLE ---
async function connectBLE(){
  if(!navigator.bluetooth){ alert("Web Bluetooth not supported."); return; }
  try{
    const device=await navigator.bluetooth.requestDevice({
      filters:[{name:'FootGuard'}],
      optionalServices:['12345678-1234-1234-1234-123456789abc']
    });
    const server=await device.gatt.connect();
    const service=await server.getPrimaryService('12345678-1234-1234-1234-123456789abc');
    const s1Char=await service.getCharacteristic('11111111-1234-1234-1234-123456789abc');
    const s2Char=await service.getCharacteristic('22222222-1234-1234-1234-123456789abc');
    await s1Char.startNotifications();
    await s2Char.startNotifications();
    s1Char.addEventListener('characteristicvaluechanged', e=>{
      const value=e.target.value.getUint8(0);
      const last2=pressureChart.data.datasets[1].data.slice(-1)[0] || 0;
      addData(value,last2);
    });
    s2Char.addEventListener('characteristicvaluechanged', e=>{
      const value=e.target.value.getUint8(0);
      const last1=pressureChart.data.datasets[0].data.slice(-1)[0] || 0;
      addData(last1,value);
    });
    bleConnected=true;
    clearInterval(simulatedInterval);
    alert("Arduino BLE connected!");
  } catch(err){ console.error(err); alert("BLE connection failed: "+err); }
}
</script>
</body>
</html>
