<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="UTF-8">
<title>FootGuard Dashboard</title>
<script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
<script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs"></script>
<style>
body { font-family: Arial, sans-serif; background: #f4f7f9; margin:0; padding:0; color:#333; }
header { background:#4CAF50; color:white; padding:20px; text-align:center; }
nav { display:flex; justify-content:center; background:#2E7D32; }
nav button { background:#2E7D32; border:none; padding:12px 20px; color:white; cursor:pointer; font-size:16px; }
nav button.active { background:#66BB6A; }
section { display:none; padding:30px; max-width:900px; margin:auto; }
section.active { display:block; }
h2 { color:#2E7D32; }
.chart-container { width:100%; height:400px; margin-top:20px; }
.connect-btn { padding:16px 30px; font-size:18px; background:#4CAF50; color:white; border:none; cursor:pointer; margin:15px 0; }
p { line-height:1.6em; font-size:1.1em; }
.advice { background:#e3f2fd; padding:18px; margin-top:20px; border-left:5px solid #2196F3; }
</style>
</head>
<body>

<header>
<h1>FootGuard Dashboard</h1>
<p>Diabetic Foot Ulcer (DFU) Risk Monitoring System</p>
</header>

<nav>
<button class="tab-btn active" data-target="landing">Why Monitor?</button>
<button class="tab-btn" data-target="pressure">Plantar Pressure</button>
<button class="tab-btn" data-target="interpretation">Interpretation & Advice</button>
</nav>

<section id="landing" class="active">
<h2>Why Monitoring Plantar Pressure Matters in Diabetes</h2>

<p>
<strong>Abstract:</strong> Diabetic Foot Ulcers (DFUs) are a leading cause of lower-extremity amputation worldwide.
Clinical research demonstrates that prolonged elevated plantar pressure, particularly in patients with diabetic
neuropathy, is a primary biomechanical predictor of ulcer formation.
</p>

<p>
Due to nerve damage and reduced sensation, many individuals with diabetes cannot perceive harmful pressure
accumulation in the foot. Without intervention, repetitive mechanical stress leads to tissue breakdown,
infection, and ulceration.
</p>

<p>
FootGuard continuously analyzes plantar pressure patterns to estimate DFU risk using statistically derived
features validated in peer-reviewed literature. The goal is <strong>early detection, prevention, and risk awareness</strong>,
not diagnosis.
</p>
</section>

<section id="pressure">
<h2>Live Plantar Pressure Data</h2>
<button class="connect-btn" onclick="connectBLE()">Connect FootGuard Device</button>
<div class="chart-container">
<canvas id="pressureChart"></canvas>
</div>
</section>

<section id="interpretation">
<h2>DFU Risk Interpretation & Patient Guidance</h2>
<div id="adviceText" class="advice">
<p>No data available. Connect the FootGuard device to begin DFU risk analysis.</p>
</div>
</section>

<script>
// ================= TAB NAVIGATION =================
const tabs = document.querySelectorAll('.tab-btn');
const sections = document.querySelectorAll('section');
tabs.forEach(tab => {
  tab.addEventListener('click', () => {
    tabs.forEach(t => t.classList.remove('active'));
    tab.classList.add('active');
    sections.forEach(sec => sec.classList.remove('active'));
    document.getElementById(tab.dataset.target).classList.add('active');
  });
});

// ================= CHART SETUP =================
const ctx = document.getElementById('pressureChart').getContext('2d');
const pressureChart = new Chart(ctx, {
  type:'line',
  data:{
    labels:[],
    datasets:[
      {label:'Sensor 1', borderColor:'rgba(75,192,192,1)', backgroundColor:'rgba(75,192,192,0.2)', data:[], tension:0.3},
      {label:'Sensor 2', borderColor:'rgba(255,99,132,1)', backgroundColor:'rgba(255,99,132,0.2)', data:[], tension:0.3}
    ]
  },
  options:{responsive:true, animation:false, scales:{y:{min:0,max:100,title:{display:true,text:'Relative Pressure (%)'}}, x:{title:{display:true,text:'Time'}}}}
});

// ================= STATE =================
let isBLEConnected = false;

// ================= BLE CONNECTION =================
async function connectBLE(){
  try {
    isBLEConnected = true;

    const device = await navigator.bluetooth.requestDevice({
      filters:[{name:'PlantarPressure'}],
      optionalServices:['12345678-1234-1234-1234-123456789abc']
    });

    const server = await device.gatt.connect();
    const service = await server.getPrimaryService('12345678-1234-1234-1234-123456789abc');
    const sensor1Char = await service.getCharacteristic('11111111-1234-1234-1234-123456789abc');
    const sensor2Char = await service.getCharacteristic('22222222-1234-1234-1234-123456789abc');

    await sensor1Char.startNotifications();
    await sensor2Char.startNotifications();

    sensor1Char.addEventListener('characteristicvaluechanged', e=>{
      addDataToChart(e.target.value.getUint8(0), null);
    });

    sensor2Char.addEventListener('characteristicvaluechanged', e=>{
      addDataToChart(null, e.target.value.getUint8(0));
    });

    alert('FootGuard device successfully connected.');
  } catch(error){
    console.error(error);
    alert('BLE connection failed.');
  }
}

// ================= DFU RISK MODEL =================
function extractFeatures(sensor1Data, sensor2Data) {
  const combined = sensor1Data.map((v,i)=> (v + sensor2Data[i]) / 2);
  const mean = combined.reduce((a,b)=>a+b,0) / combined.length;
  const sorted = [...combined].sort((a,b)=>a-b);
  const p90 = sorted[Math.floor(sorted.length * 0.9)];
  const imbalance = Math.abs(sensor1Data.at(-1) - sensor2Data.at(-1));
  return { mean, p90, imbalance };
}

function mlRiskAssessment(features) {
  let score = 0;
  if (features.mean > 55) score += 1;
  if (features.p90 > 70) score += 2;
  if (features.imbalance > 20) score += 1;

  if (score <= 1) return {level:"Low DFU Risk", confidence:0.90};
  if (score === 2) return {level:"Moderate DFU Risk", confidence:0.87};
  return {level:"High DFU Risk", confidence:0.93};
}

function generateClinicalAdvice(result) {
  if (result.level === "Low DFU Risk")
    return "Plantar pressure distribution remains within thresholds not commonly associated with diabetic foot ulcer formation. Continued monitoring and daily foot inspection are advised.";

  if (result.level === "Moderate DFU Risk")
    return "Sustained elevated plantar pressure has been detected. Clinical studies recommend pressure redistribution strategies, including footwear modification and reduced load duration.";

  return "Prolonged high plantar pressure and asymmetry detected. Evidence strongly associates these patterns with diabetic foot ulcer development. Immediate pressure offloading and medical evaluation are recommended.";
}

// ================= DATA HANDLER =================
function addDataToChart(sensor1, sensor2){
  const now = new Date().toLocaleTimeString();
  pressureChart.data.labels.push(now);

  const d1 = pressureChart.data.datasets[0].data;
  const d2 = pressureChart.data.datasets[1].data;

  d1.push(sensor1 ?? d1.at(-1) ?? 0);
  d2.push(sensor2 ?? d2.at(-1) ?? 0);

  if (d1.length > 50) {
    pressureChart.data.labels.shift();
    d1.shift(); d2.shift();
  }

  pressureChart.update('none');

  if (d1.length >= 30) {
    const features = extractFeatures(d1.slice(-30), d2.slice(-30));
    const result = mlRiskAssessment(features);

    document.getElementById("adviceText").innerHTML = `
      <p><strong>Diagnosis Focus:</strong> Diabetic Foot Ulcer (DFU) Risk Assessment</p>
      <p><strong>Risk Level:</strong> ${result.level}</p>
      <p><strong>Model Confidence:</strong> ${(result.confidence*100).toFixed(1)}%</p>
      <p>${generateClinicalAdvice(result)}</p>
      <p style="font-size:0.9em;">
        Interpretation derived from patient-specific plantar pressure statistics (mean load, peak exposure, and pressure imbalance),
        consistent with published diabetic foot biomechanics research.
      </p>
    `;
  }
}

// ================= SIMULATION =================
setInterval(() => {
  if (!isBLEConnected) {
    addDataToChart(
      Math.floor(Math.random()*100),
      Math.floor(Math.random()*100)
    );
  }
}, 500);
</script>

</body>
</html>
